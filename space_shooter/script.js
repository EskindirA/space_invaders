// Generated by CoffeeScript 1.6.3
(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};window.onload=function(){var t,n,r,i,s,o,u;window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)}}();n=document.getElementById("intro");r=document.getElementById("loading");n.className="active";document.addEventListener("keydown",u=function(e){if(e.keyCode===32){document.removeEventListener("keydown",u);r.className="active";n.className="";return i.load()}},!1);i={done:0,required:2,load:function(){this.done++;if(this.done===this.required)return o()}};t={images:[],loaded:0,paths:["images/bg-o.png","images/bg2.png","images/explosion.png","images/explosion2.png","images/sprite.png"],loadImages:function(){var e,t,n,r,s,o,u,a=this;o=this.paths;u=[];for(e=r=0,s=o.length;r<s;e=++r){n=o[e];t=new Image;this.images.push({path:n,img:t});t.onload=function(){a.loaded++;if(a.loaded===a.paths.length)return i.load()};u.push(t.src=this.paths[e])}return u},get:function(e){var t;t=this.images.filter(function(t){return t.path===e});return t[0].img}};t.loadImages();s={shoot:new Howl({urls:["sounds/shoot.ogg","sounds/shoot.mp3"],volume:.14}),explosion:new Howl({urls:["sounds/explosion.ogg","sounds/explosion.mp3"],volume:.5}),background:new Howl({urls:["sounds/background.ogg","sounds/background.mp3"],loop:!0,buffer:!0,volume:.7})};return o=function(){var n,i,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;l=document.getElementById("cont");m=document.getElementById("game_over");v=document.getElementById("levelup");y=document.getElementById("lives");g=document.getElementById("ingame_level");d=document.getElementById("info_level");b=document.getElementById("mute");f=document.getElementById("game_screen");a=f.getContext("2d");S=Date.now();E=function(e,t){return Math.floor(Math.random()*(t-e+1))+e};p={width:900,height:630,level:0,lives:3,timeOfLastDeath:0,deltaLastTime:0,paused:{levelup:!1,over:!1},muted:!1,time:function(){return Date.now()-S}};f.width=p.width;f.height=p.height;p.setSize=function(){var e,t,n;n=window.innerWidth;t=window.innerHeight;e=(t-100)/p.height;e>1.1&&(e=1.1);p.scale(e);if(n-20<+f.style.width.replace("px",""))return p.scale((n-40)/p.width)};p.scale=function(e){l.style.width=p.width*e+"px";f.style.width=p.width*e+"px";return f.style.height=p.height*e+"px"};window.addEventListener("resize",function(){return p.setSize()},!1);p.setSize();u=function(){function t(t,n,r,i,s,o,u,a,f){this.image=t;this.cTop=n;this.cSize=r;this.pos=i;this.size=s;this.speed=o;this.frames=u;this.once=a;this.length=f;this.draw=e(this.draw,this);this.animation=e(this.animation,this);this.ticker=0}t.prototype.animation=function(e,t){this.frames=e;t!=null&&(this.once=t);this.ticker=0;return this.done=!1};t.prototype.draw=function(){var e,t,n;if(!this.done){this.frames||(this.frames=function(){var e,t,r;r=[];for(n=e=0,t=this.length-1;0<=t?e<=t:e>=t;n=0<=t?++e:--e)r.push(n);return r}.call(this));this.ticker+=this.speed*c;t=Math.floor(this.ticker);e=this.frames[t%this.frames.length];this.cLeft=e*this.cSize[0];this.once&&t>=this.frames.length-1&&(this.done=!0)}return a.drawImage(this.image,this.cLeft,this.cTop,this.cSize[0],this.cSize[1],this.pos[0],this.pos[1],this.size[0],this.size[1])};return t}();n=function(){function e(t,n,r,i,s,o,u){this.image=t;this.height=n;this.width=r;this.top=i;this.left=s;this.isPlayers=o;this.horzMovement=u;e.bullets.push(this)}e.bullets=[];e.move=function(){var e,t,n,r,i,s,o;this.bullets=this.bullets.filter(function(e){return!(e.top+e.height<0||e.top>p.height)});s=this.bullets;o=[];for(r=0,i=s.length;r<i;r++){e=s[r];if(e.isPlayers)o.push(e.top-=Math.round(10*c));else{t=Math.round(1*e.horzMovement*p.level/8*c);n=Math.round((3+p.level/4)*c);e.left+=t;e.top+=n;e.image.pos[0]+=t;o.push(e.image.pos[1]+=n)}}return o};e.draw=function(){var e,t,n,r,i;r=this.bullets;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];e.isPlayers?i.push(a.drawImage(e.image,0,276,7,14,e.left,e.top,e.width,e.height)):i.push(e.image.draw())}return i};return e}();w={width:60,height:60};w.left=p.width/2-w.width/2;w.top=p.height-w.height-10;w.sp=30;w.tp=20;w.sprite=new u(t.get("images/sprite.png"),101,[128,120],[w.left,w.top],[w.width+w.sp,w.height+w.tp],.3,[3],"once");w.move=function(){this.isMovingLeft&&this.left>20?this.left-=Math.round(12*c):this.isMovingRight&&this.left<p.width-this.width-20&&(this.left+=Math.round(12*c));this.isMovingUp&&this.top>p.height-w.height-100?this.top-=Math.round(6*c):this.isMovingDown&&this.top<p.height-w.height-10&&(this.top+=Math.round(6*c));w.sprite.pos[0]=this.left-w.sp/2;return w.sprite.pos[1]=this.top-w.tp};w.draw=function(){return w.sprite.draw()};w.shoot=function(){var e,r,i,o;e=18;o=9;r=w.left+w.width/2-o/2;i=w.top-e;new n(t.get("images/sprite.png"),e,o,i,r-15,!0,null);new n(t.get("images/sprite.png"),e,o,i,r+15,!0,null);this.initMuzzleFlash();if(!p.muted)return s.shoot.play()};w.flashes=[];w.initMuzzleFlash=function(){w.flashes.push(new u(t.get("images/sprite.png"),240,[56,36],[0,0],[32,32],.8,!1,"once",4));return w.flashes.push(new u(t.get("images/sprite.png"),240,[56,36],[0,0],[32,32],.8,!1,"once",4))};w.drawFlashes=function(){var e,t,n,r,i,s,o;this.flashes=this.flashes.filter(function(e){return!e.done});s=this.flashes;o=[];for(t=r=0,i=s.length;r<i;t=++r){e=s[t];n=t%2===0?-15:15;e.pos[0]=w.left+w.width/2+n-16;e.pos[1]=w.top+12-36;o.push(e.draw())}return o};o=function(){function e(t,n,r,i,s,o,u,a,f){this.cLeft=t;this.cTop=n;this.cWidth=r;this.cHeight=i;this.left=s;this.top=o;this.width=u;this.height=a;this.dead=f;this.patrol={left:0,top:0};this.lives=2;e.invaders.push(this)}e.invaders=[];e.speed=1;e.patrolSwitch=0;e.deploy=function(){var t,n,r,i,s,o,u,a,f,l,c,h;u=[[105,0,100,100],[205,0,103,100],[312,0,103,100],[415,0,103,100],[631,0,104,100],[738,0,100,100],[845,0,105,100],[954,0,103,100],[0,0,105,100],[518,0,111,100]];o=p.level%10;n=u[o][0];r=u[o][1];i=u[o][2];t=u[o][3];l=70;s=50;this.p=15;f=-(s+this.p)*3;a=p.width/2-((l+this.p)*8-this.p)/2;h=[];for(o=c=0;c<=23;o=++c)h.push(new e(n,r,i,t,a+o%8*(l+this.p),f+o%3*(s+this.p),l,s,!1));return h};e.move=function(){var t,n,r,i,s,o,u,a,f,l,h,d,v;r=[];o=[];h=this.invaders;for(u=0,f=h.length;u<f;u++){t=h[u];r.push(t.left);o.push(t.left+t.width)}n=Math.min.apply(Math,r);s=Math.max.apply(Math,o);i=Date.now();if((n<20||s>p.width-20)&&i-this.patrolSwitch>1e3){this.speed=-this.speed;this.patrolSwitch=i}d=e.invaders;v=[];for(a=0,l=d.length;a<l;a++){t=d[a];if(t.patrol.top<(t.height+this.p)*3+20){t.patrol.top+=Math.round(2*c);v.push(t.top+=Math.round(2*c))}else v.push(t.left+=Math.round(this.speed*c))}return v};e.draw=function(){var n,r,i,s,o;s=e.invaders;o=[];for(r=0,i=s.length;r<i;r++){n=s[r];o.push(a.drawImage(t.get("images/sprite.png"),n.cLeft,n.cTop,n.cWidth,n.cHeight,n.left,n.top,n.width,n.height))}return o};e.shoot=function(){var r,i,s,o,a,f,l,c,h,d,v,m,g,y,b;g=e.invaders;b=[];for(h=0,v=g.length;h<v;h++){o=g[h];r=!1;y=e.invaders;for(d=0,m=y.length;d<m;d++){s=y[d];o.top<s.top&&o.left<s.left+o.width&&o.left+o.width>s.left&&(r=!0)}if(E(-1e3,2+p.level/2)>-1&&!r){f=18;c=o.top+o.height;a=o.left+o.width/2-f/2;i=E(-10,10)/10;l=new u(t.get("images/sprite.png"),222,[f,f],[a,c],[f,f],200,!1,!1,18);b.push(new n(l,f,f,c,a,!1,i))}else b.push(void 0)}return b};return e}();i=function(){function e(n,r,i,s){var o;this.left=n;this.top=r;this.size=i;this.type=s;n=this.left-this.size/2;r=this.top-this.size/2;this.type==="shockwave"?o=new u(t.get("images/explosion2.png"),0,[83.333,83],[n,r],[this.size,this.size],.65,!1,"once",48):o=new u(t.get("images/explosion.png"),0,[88,88],[n,r],[this.size,this.size],.8,!1,"once",64);e.explosions.push(o)}e.explosions=[];e.draw=function(){var e,t,n,r,i;this.explosions=this.explosions.filter(function(e){return!e.done});r=this.explosions;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];i.push(e.draw())}return i};return e}();p.colliding=function(e,t){return e.left<t.left+t.width&&e.left+e.width>t.left&&e.top<t.top+t.height&&e.height+e.top>t.top};p.handleCollisions=function(){var e,t,r,u,a,f,l,c,h,d,v,m;v=n.bullets;for(t=l=0,h=v.length;l<h;t=++l){e=v[t];if(this.colliding(w,e)&&!e.isPlayers&&this.time()-this.timeOfLastDeath>800){this.lives--;this.timeOfLastDeath=this.time();e.dead=!0;this.updateScore();new i(w.left+w.width/2,w.top+20,120,"impact");p.muted||s.explosion.play()}m=o.invaders;for(u=c=0,d=m.length;c<d;u=++c){r=m[u];if(this.colliding(r,e)&&e.isPlayers){e.dead=!0;r.lives--;r.lives||(r.dead=!0);f=r.dead&&E(-10,5)>0?"shockwave":"impact";a=f==="shockwave"?100+E(1,40):80+E(1,40);new i(r.left+r.width/2,r.top+r.height/2,a,f);p.muted||s.explosion.play()}}}n.bullets=n.bullets.filter(function(e){return!e.dead});return o.invaders=o.invaders.filter(function(e){return!e.dead})};p.bgPos=0;p.bgPos2=0;p.loopBackground=function(){var e,n;this.bgPos+=Math.round(c*1);this.bgPos2+=Math.round(c*2);e=p.height;a.drawImage(t.get("images/bg-o.png"),0,this.bgPos,p.width,e);a.drawImage(t.get("images/bg-o.png"),0,this.bgPos-e,p.width,e);this.bgPos>=e&&(this.bgPos=0);n=p.height;a.drawImage(t.get("images/bg2.png"),0,this.bgPos2,p.width,n);a.drawImage(t.get("images/bg2.png"),0,this.bgPos2-n,p.width,n);if(this.bgPos2>=n)return this.bgPos2=0};p.updateScore=function(){var e,t,n,r;t=[];if(p.lives)for(e=n=1,r=p.lives;1<=r?n<=r:n>=r;e=1<=r?++n:--n)t.push("<img src='images/life.png'>");y.innerHTML=t.join("");g.textContent=p.level;return d.textContent=p.level};c=0;h=!0;p.setDeltaLastTime=function(){var e;if(h){h=!1;p.deltaLastTime=Date.now()}e=Date.now();c=(e-p.deltaLastTime)/1e3*60;return p.deltaLastTime=e};p.dealWithEvents=function(){var e=this;if(this.lives===0&&!this.paused.over){this.paused.over=!0;setTimeout(function(){var t;return document.addEventListener("keydown",t=function(n){if(n.keyCode===32){document.removeEventListener("keydown",t);e.paused.over=!1;m.className="";s.background.pos(0);return e.init(1,3)}},!1)},1e3)}else if(o.invaders.length===0&&!this.paused.levelup){this.paused.levelup=!0;this.level++;this.updateScore();setTimeout(function(){e.paused.levelup=!1;v.className="";return e.init(e.level,e.lives)},2e3)}if(this.paused.over)return m.className="active";if(this.paused.levelup)return v.className="active"};p.update=function(){p.loopBackground();p.setDeltaLastTime();if(!p.paused.over){w.move();w.draw()}if(!p.paused.levelup){o.move();o.draw()}if(!p.paused.over&&!p.paused.levelup){p.handleCollisions();o.shoot()}n.move();n.draw();i.draw();w.drawFlashes();p.dealWithEvents();return requestAnimationFrame(p.update)};p.init=function(e,t){this.level=e;this.lives=t;n.bullets=[];o.invaders=[];o.deploy();return this.updateScore()};document.addEventListener("keydown",function(e){if(e.keyCode===37){w.leftPressed||w.sprite.animation([2,1,0]);w.leftPressed=!0;w.isMovingLeft=!0;return w.isMovingRight=!1}if(e.keyCode===39){w.rightPressed||w.sprite.animation([4,5,6]);w.rightPressed=!0;w.isMovingRight=!0;return w.isMovingLeft=!1}if(e.keyCode===38){w.upPressed=!0;w.isMovingUp=!0;return w.isMovingDown=!1}if(e.keyCode===40){w.downPressed=!0;w.isMovingDown=!0;return w.isMovingUp=!1}if(e.keyCode===32){e.preventDefault();if(!p.paused.over&&!p.paused.levelup)return w.shoot()}},!1);document.addEventListener("keyup",function(e){if(e.keyCode===37){w.leftPressed=!1;w.isMovingLeft=!1;w.rightPressed&&(w.isMovingRight=!0);return w.rightPressed?w.sprite.animation([4,5,6]):w.sprite.animation([1,2,3])}if(e.keyCode===39){w.rightPressed=!1;w.isMovingRight=!1;w.leftPressed&&(w.isMovingLeft=!0);return w.leftPressed?w.sprite.animation([2,1,0]):w.sprite.animation([5,4,3])}if(e.keyCode===38){w.upPressed=!1;w.isMovingUp=!1;if(w.downPressed)return w.isMovingDown=!0}else if(e.keyCode===40){w.downPressed=!1;w.isMovingDown=!1;if(w.upPressed)return w.isMovingUp=!0}},!1);b.addEventListener("click",function(){p.muted?s.background.unmute():s.background.mute();return p.muted=!p.muted},!1);p.update();r.className="";return s.background.play()}}}).call(this);